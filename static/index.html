<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Acme Product Importer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <div class="container">
    <h1>Acme Product Importer</h1>
    <p>Upload CSV (max 500k rows). CSV must include a <code>sku</code> column (case-insensitive).</p>

    <div class="mb-3">
      <input id="csvFile" type="file" class="form-control" />
    </div>
    <button id="uploadBtn" class="btn btn-primary">Upload</button> 
    <div class="mt-3">
      <div class="progress">
        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
      </div>
      <div id="statusText" class="mt-2"></div>
    </div>

    <hr />
    <a href="/products.html">Manage Products</a> |
    <a href="/webhooks.html">Webhooks</a>
  </div>

  <script>
  const uploadBtn = document.getElementById('uploadBtn');
  const csvFile = document.getElementById('csvFile');
  const progressBar = document.getElementById('progressBar');
  const statusText = document.getElementById('statusText');

  uploadBtn.addEventListener('click', async () => {
    const file = csvFile.files[0];
    if (!file) { alert('Choose a file'); return; }

    const form = new FormData();
    form.append('file', file);
    statusText.textContent = 'Uploading...';

    const resp = await fetch('/api/upload', { method: 'POST', body: form });
    const data = await resp.json();
    if (!data.job_id) {
      statusText.textContent = 'Upload failed';
      return;
    }
    const jobId = data.job_id;
    pollProgress(jobId);
  });

  async function pollProgress(jobId) {
    const res = await fetch(`/api/progress/${jobId}`);
    const obj = await res.json();

    if (obj.status === 'NOT_FOUND') {
      statusText.textContent = 'Waiting for worker...';
      setTimeout(() => pollProgress(jobId), 1000);
      return;
    }

    const status = obj.status || '';

    if (status.startsWith('ERROR')) {
      statusText.textContent = status;
      progressBar.style.width = '0%';
      progressBar.textContent = 'Error';
      return;
    }

    if (status.startsWith('COMPLETED')) {
      progressBar.style.width = '100%';
      progressBar.textContent = '100%';
      statusText.textContent = status;
      return;
    }

    if (status.includes('/')) {
      const [cur, total] = status.split('/');
      const pct = Math.round((parseInt(cur) / parseInt(total)) * 100);
      progressBar.style.width = pct + '%';
      progressBar.textContent = pct + '%';
      statusText.textContent = `Processed ${cur} of ${total}`;
    } else {
      statusText.textContent = status;
    }

    setTimeout(() => pollProgress(jobId), 1000);
  }
  </script>
</body>
</html>
